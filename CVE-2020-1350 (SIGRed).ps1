<#
.SYNOPSIS  
    Script to check whether a system is vulnerable to CVE 2020-1350 and if vulnerable, offers to implement the temporary fix depicted by Microsoft.

.LINK
    https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1350
#>


$os = Get-CimInstance -ClassName win32_operatingsystem | select-object caption, servicepackmajorversion

function vul{
 write-host -ForegroundColor Yellow "[+] " -NoNewline; Write-Host -ForegroundColor Red "Vulnerable to CVE 2020-1350: System is missing patch"; ' '
 while($answer -ne 'y' -or $answer -ne 'n'){
     $answer = read-host "Do you want to implement the temporary fix (y or n)?"
         if($answer -eq 'y'){
            tempFix
         }
         elseif($answer -eq 'n'){
            break
         }
    }
}

function notVul{
    write-host -ForegroundColor Yellow "[+] " -NoNewline; Write-Host -ForegroundColor Green "Not vulnerable to CVE 2020-1350: System is patched"
}

function tempFix{
    Set-ItemProperty hklm:\system\currentcontrolset\services\dns\parameters -Name TcpReceivePacketSize -Value 0xFF00
    if(get-itemproperty hklm:\system\currentcontrolset\services\dns\parameters -Name TcpReceivePacketSize){
        write-host -ForegroundColor Yellow "[+] " -NoNewline; Write-Host -ForegroundColor Green "Not vulnerable to CVE 2020-1350: System has the temporary fix implemented"
    }
}

if(get-service dns -ErrorAction SilentlyContinue){
    $patches = (Get-HotFix).hotfixid

    if($os -like "*server 2008 r2*" -and $os.servicepackmajorversion -eq '2'){
        if($patches -match "4565524" -or $patches -match "4565539"){
            notVul
        }
        else{
            vul     
        }
    }
    elseif($os -like "*server 2008*" -and $os.servicepackmajorversion -eq '1'){
        if($patches -match "4565536" -or $patches -match "4565529"){
            notVul
        }
        else{
            vul          
        }
    }
    elseif($os -like "*server 2012 r2*"){
        if($patches -match "4565541" -or $patches -match "4565540"){
            notVul
        }
        else{
            vul           
        }
    }
    elseif($os -like "*server 2012*"){
        if($patches -match "4565537" -or $patches -match "4565535"){
            notVul
        }
        else{
            vul           
        }
    }
    elseif($os -like "*server 2016*"){
        if($patches -match "4565511"){
            notVul
        }
        else{
            vul           
        }
    }
    elseif($os -like "*server 2019*"){
        if($patches -match "4558998"){
            notVul
        }
        else{
            vul           
        }
    }
    else{
        write-host -ForegroundColor Yellow "[+] " -NoNewline; Write-Host -ForegroundColor Green "Not vulnerable to CVE 2020-1350: System is not a vulnerable operating system"  
    }
}
else{
    write-host -ForegroundColor Yellow "[+] " -NoNewline; Write-Host -ForegroundColor Green "Not vulnerable to CVE 2020-1350: System is not a DNS Server"
}

